<!DOCTYPE html>
<!-- Generated by pkgdown: do not edit by hand --><html>
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>fabricatr - Cross-classified (partially nested) data</title>
<!-- jquery --><script src="https://code.jquery.com/jquery-3.1.0.min.js" integrity="sha384-nrOSfDHtoPMzJHjVTdCopGqIqeYETSXhZDFyniQ8ZHcVy08QesyHcnOUpMpqnmWq" crossorigin="anonymous"></script><!-- Bootstrap --><link href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-BVYiiSIFeK1dGmJRAkycuHAHRg32OmUcww7on3RYdg4Va+PmSTsz/K68vbdEjh4u" crossorigin="anonymous">
<script src="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/js/bootstrap.min.js" integrity="sha384-Tc5IQib027qvyjSMfHjOMaLkfuWVxZxUPnCJA7l2mCWNIpG9mGCD8wGNIcPD7Txa" crossorigin="anonymous"></script><!-- Font Awesome icons --><link href="https://maxcdn.bootstrapcdn.com/font-awesome/4.6.3/css/font-awesome.min.css" rel="stylesheet" integrity="sha384-T8Gy5hrqNKT+hzMclPo118YTQO6cYprQmhrYwIiQ/3axmI1hQomh7Ud2hPOy8SP1" crossorigin="anonymous">
<!-- pkgdown --><link href="../pkgdown.css" rel="stylesheet">
<script src="../jquery.sticky-kit.min.js"></script><script src="../pkgdown.js"></script><!-- mathjax --><script src="https://mathjax.rstudio.com/latest/MathJax.js?config=TeX-AMS-MML_HTMLorMML"></script><!--[if lt IE 9]>
<script src="https://oss.maxcdn.com/html5shiv/3.7.3/html5shiv.min.js"></script>
<script src="https://oss.maxcdn.com/respond/1.4.2/respond.min.js"></script>
<![endif]-->
</head>
<body>
    <div class="container template-vignette">
      <header><div class="navbar navbar-default navbar-fixed-top" role="navigation">
  <div class="container">
    <div class="navbar-header">
      <button type="button" class="navbar-toggle collapsed" data-toggle="collapse" data-target="#navbar">
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
      </button>
      <a class="navbar-brand" href="../">fabricatr</a>
    </div>
    <div id="navbar" class="navbar-collapse collapse">
      <ul class="nav navbar-nav">
<li class="dropdown">
  <a href="#" class="dropdown-toggle" data-toggle="dropdown" role="button" aria-expanded="false">
    Getting Started
     
    <span class="caret"></span>
  </a>
  <ul class="dropdown-menu" role="menu">
<li>
      <a href="../articles/getting_started.html">Getting Started</a>
    </li>
    <li>
      <a href="../articles/variable_generation.html">Generating Variables</a>
    </li>
    <li>
      <a href="../articles/resampling.html">Resampling</a>
    </li>
    <li>
      <a href="../articles/cross_classified.html">Cross-classified Data</a>
    </li>
    <li>
      <a href="../articles/advanced_features.html">Advanced Features</a>
    </li>
  </ul>
</li>
<li>
  <a href="../reference/">Reference</a>
</li>
<li>
  <a href="http://discuss.declaredesign.org">Ask for Help</a>
</li>
<li class="dropdown">
  <a href="#" class="dropdown-toggle" data-toggle="dropdown" role="button" aria-expanded="false">
    Packages
     
    <span class="caret"></span>
  </a>
  <ul class="dropdown-menu" role="menu">
<li>
      <a href="http://declaredesign.org">DeclareDesign</a>
    </li>
    <li>
      <a href="http://randomizr.declaredesign.org">randomizr</a>
    </li>
    <li>
      <a href="http://fabricatr.declaredesign.org">fabricatr</a>
    </li>
    <li>
      <a href="http://estimatr.declaredesign.org">estimatr</a>
    </li>
  </ul>
</li>
<li>
  <a href="http://declaredesign.org">DeclareDesign home</a>
</li>
      </ul>
<ul class="nav navbar-nav navbar-right">
<li>
  <a></a>
</li>
      </ul>
</div>
<!--/.nav-collapse -->
  </div>
<!--/.container -->
</div>
<!--/.navbar -->

      
      </header><div class="row">
  <div class="col-md-9">
    <div class="page-header toc-ignore">
      <h1>Cross-classified (partially nested) data</h1>
                        <h4 class="author">Aaron Rudkin</h4>
            
          </div>

    
    
<div class="contents">
<p>Although much of <strong>fabricatr</strong>’s is designed to generate hierarchical, nested data, we also provide functions to generate cross-classified (partially nested) data. In this vignette, we consider the example of generating data about students, whose educational outcomes depend on both the primary and secondary school they attend.</p>
<p>Let’s begin by visualizing how our data will be laid out:</p>
<p><img src="cross_classified_files/figure-html/unnamed-chunk-2-1.png" width="480"></p>
<p>Primary schools and secondary schools each exist independent of each other and have some specific characteristics. Students draw from a single primary school and a single secondary school, and may also have some individual characteristics.</p>
<p>The main steps involved in generating cross-classified data are as follows:</p>
<ol style="list-style-type: decimal">
<li>Generate multiple non-nested data frames (Primary and Secondary Schools)</li>
<li>Use the [<code>cross_classify()</code>] function to join the non-nested data frames on particular variables, optionally specifying a desired correlation outcome.</li>
<li>Optionally, add new variables or further levels in the resulting cross-classified data. (Students)</li>
</ol>
<div id="generating-multiple-non-nested-levels-using-fabricatr" class="section level1">
<h1 class="hasAnchor">
<a href="#generating-multiple-non-nested-levels-using-fabricatr" class="anchor"></a>Generating multiple non-nested levels using <strong>fabricatr</strong>
</h1>
<p>As with nested data, the workhorse function for ge_nerating new levels of data is [<code><a href="../reference/fabricate.html">add_level()</a></code>]. To generate multiple non-nested levels of data, it is necessary to add an additional argument in the following form:</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">schools_data &lt;-<span class="st"> </span><span class="kw"><a href="../reference/fabricate.html">fabricate</a></span>(
  <span class="dt">primary_schools =</span> <span class="kw"><a href="../reference/fabricate.html">add_level</a></span>(<span class="dt">N =</span> <span class="dv">20</span>, <span class="dt">ps_quality =</span> <span class="kw">runif</span>(N, <span class="dv">1</span>, <span class="dv">10</span>)),
  <span class="dt">secondary_schools =</span> <span class="kw"><a href="../reference/fabricate.html">add_level</a></span>(<span class="dt">N =</span> <span class="dv">15</span>, <span class="dt">ss_quality =</span> <span class="kw">runif</span>(N, <span class="dv">1</span>, <span class="dv">10</span>), <span class="dt">nest =</span> <span class="ot">FALSE</span>),
  ...
)</code></pre></div>
<p>Observe that the second (and any subsequent) non-nested levels should contain the <code>nest = FALSE</code> argument – otherwise, secondary schools would be interpreted to be a level nested within schools. Each level can have as many variables as you want, and <strong>fabricatr</strong> will internally track each level separately.</p>
<p>This [<code><a href="../reference/fabricate.html">fabricate()</a></code>] call is incomplete – so far we have just completed the first step. We must also specify how to merge the two levels. If you do not specify a way to merge the levels, [<code><a href="../reference/fabricate.html">fabricate()</a></code>] will return the most recent working data frame: in this case, the secondary schools level.</p>
</div>
<div id="importing-non-nested-data-frames" class="section level1">
<h1 class="hasAnchor">
<a href="#importing-non-nested-data-frames" class="anchor"></a>Importing non-nested data frames</h1>
<p>You can also import the data you wish to cross-classify on from existing data sources, or a combination of imported data and data specified using <strong>fabricatr</strong>. Recall that the first argument to a [<code><a href="../reference/fabricate.html">fabricate()</a></code>] call is the data you wish to import. We have previously seen that it is possible to import a single data frame this way, but it is also possible to import a list of data frames, staging them all for use for cross-classifying data. Data imported in this manner looks like this:</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">schools_data &lt;-<span class="st"> </span><span class="kw"><a href="../reference/fabricate.html">fabricate</a></span>(
  <span class="kw">list</span>(primary_schools, secondary_schools),
  ...
)</code></pre></div>
<p>Again, the [<code><a href="../reference/fabricate.html">fabricate()</a></code>] call is incomplete – we have imported the data we wish to cross-classify on, but not yet learned how to merge the data.</p>
</div>
<div id="specifying-a-merge-function" class="section level1">
<h1 class="hasAnchor">
<a href="#specifying-a-merge-function" class="anchor"></a>Specifying a merge function</h1>
<p>Specifying a merge function is as easy as telling <strong>fabricatr</strong> which variables you wish to merge on, and how many resulting observations to make. Suppose we wish to create a school system that contains 1500 students, each of whom attends a single primary school and a single secondary school. At this stage, we want the allocations to primary and secondary schools to be random (no correlation between the types of schools people attend):</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">schools_data &lt;-<span class="st"> </span><span class="kw"><a href="../reference/fabricate.html">fabricate</a></span>(
  <span class="dt">primary_schools =</span> <span class="kw"><a href="../reference/fabricate.html">add_level</a></span>(<span class="dt">N =</span> <span class="dv">20</span>, <span class="dt">ps_quality =</span> <span class="kw">runif</span>(N, <span class="dv">1</span>, <span class="dv">10</span>)),
  <span class="dt">secondary_schools =</span> <span class="kw"><a href="../reference/fabricate.html">add_level</a></span>(<span class="dt">N =</span> <span class="dv">15</span>, <span class="dt">ss_quality =</span> <span class="kw">runif</span>(N, <span class="dv">1</span>, <span class="dv">10</span>), <span class="dt">nest =</span> <span class="ot">FALSE</span>),
  <span class="dt">students =</span> <span class="kw"><a href="../reference/cross_level.html">cross_level</a></span>(<span class="dt">N =</span> <span class="dv">1500</span>, <span class="dt">by =</span> <span class="kw"><a href="../reference/join.html">join</a></span>(primary_schools, secondary_schools))
)</code></pre></div>
<p>Merging requires the use of two functions: first, a [<code><a href="../reference/cross_level.html">cross_level()</a></code>] call, which specifies information about the resulting, merged level. In the simplest case, we need only specify an <code>N</code>, the number of observations to create. Second, a [<code><a href="../reference/join.html">join()</a></code>] call passed to the <code>by</code> argument, which specifies how to join the two levels. In this case we are joining on the ID variables (primary_schools and secondary_schools), which have no substantive meaning but allow us to track which school is which.</p>
<p>The result is, predictably, a data frame containing 1500 observations, each of five columns: primary_schools (ID), ps_quality, secondary_schools (ID), ss_quality, and students (ID).</p>
</div>
<div id="adding-additional-variables" class="section level1">
<h1 class="hasAnchor">
<a href="#adding-additional-variables" class="anchor"></a>Adding additional variables</h1>
<p>Additional variables can easily be added to cross-classified data, just as they can be added to any other <strong>fabricatr</strong> level call:</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">schools_data &lt;-<span class="st"> </span><span class="kw"><a href="../reference/fabricate.html">fabricate</a></span>(
  <span class="dt">primary_schools =</span> <span class="kw"><a href="../reference/fabricate.html">add_level</a></span>(<span class="dt">N =</span> <span class="dv">20</span>, <span class="dt">ps_quality =</span> <span class="kw">runif</span>(N, <span class="dv">1</span>, <span class="dv">10</span>)),
  <span class="dt">secondary_schools =</span> <span class="kw"><a href="../reference/fabricate.html">add_level</a></span>(<span class="dt">N =</span> <span class="dv">15</span>, <span class="dt">ss_quality =</span> <span class="kw">runif</span>(N, <span class="dv">1</span>, <span class="dv">10</span>), <span class="dt">nest =</span> <span class="ot">FALSE</span>),
  <span class="dt">students =</span> <span class="kw"><a href="../reference/cross_level.html">cross_level</a></span>(<span class="dt">N =</span> <span class="dv">1500</span>, <span class="dt">by =</span> <span class="kw"><a href="../reference/join.html">join</a></span>(primary_schools, secondary_schools),
                         <span class="dt">SAT_score =</span> <span class="dv">800</span> <span class="op">+</span><span class="st"> </span>
<span class="st">                           </span><span class="dv">13</span> <span class="op">*</span><span class="st"> </span>ps_quality <span class="op">+</span><span class="st"> </span>
<span class="st">                           </span><span class="dv">26</span> <span class="op">*</span><span class="st"> </span>ss_quality <span class="op">+</span><span class="st"> </span>
<span class="st">                           </span><span class="kw">rnorm</span>(N, <span class="dv">0</span>, <span class="dv">50</span>))
)</code></pre></div>
<p>Here, each student is assigned a standardized testing score, equal to a baseline, plus an additive effect from the quality of their primary school, plus a large additive effect from the quality of their secondary school, plus a stochastic component.</p>
<p>A linear regression confirms that the resulting data approximately reflects the the data generating process:</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="kw">lm</span>(SAT_score <span class="op">~</span><span class="st"> </span>ps_quality <span class="op">+</span><span class="st"> </span>ss_quality, <span class="dt">data=</span>schools_data)</code></pre></div>
<table class="table">
<thead><tr class="header">
<th></th>
<th align="right">Estimate</th>
<th align="right">Std. Error</th>
<th align="right">t value</th>
<th align="right">Pr(&gt;|t|)</th>
</tr></thead>
<tbody>
<tr class="odd">
<td>(Intercept)</td>
<td align="right">800</td>
<td align="right">4.09</td>
<td align="right">196</td>
<td align="right">0</td>
</tr>
<tr class="even">
<td>ps_quality</td>
<td align="right">13</td>
<td align="right">0.40</td>
<td align="right">33</td>
<td align="right">0</td>
</tr>
<tr class="odd">
<td>ss_quality</td>
<td align="right">26</td>
<td align="right">0.57</td>
<td align="right">46</td>
<td align="right">0</td>
</tr>
</tbody>
</table>
<p>Other variables can be added in the <em>students</em> level, or indeed in either of the component levels.</p>
</div>
<div id="correlations-after-merging" class="section level1">
<h1 class="hasAnchor">
<a href="#correlations-after-merging" class="anchor"></a>Correlations after merging</h1>
<p>The functionality discussed up until now is implemented in a variety of R packages. A key feature of <strong>fabricatr</strong> is that the resulting joined data can be sampled such that is has a specific correlation on the joined variables. We might, for example, reasonably assume that students assigned to better primary schools are later assigned to better secondary schools – whether due to economic geography of the area, selective admissions, or other causes. It is easy to specify a correlation between these outcomes using much the same syntax we used before:</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">corr_data &lt;-<span class="st"> </span><span class="kw"><a href="../reference/fabricate.html">fabricate</a></span>(
  <span class="dt">primary_schools =</span> <span class="kw"><a href="../reference/fabricate.html">add_level</a></span>(<span class="dt">N =</span> <span class="dv">20</span>, <span class="dt">ps_quality =</span> <span class="kw">runif</span>(N, <span class="dv">1</span>, <span class="dv">10</span>)),
  <span class="dt">secondary_schools =</span> <span class="kw"><a href="../reference/fabricate.html">add_level</a></span>(<span class="dt">N =</span> <span class="dv">15</span>, <span class="dt">ss_quality =</span> <span class="kw">runif</span>(N, <span class="dv">1</span>, <span class="dv">10</span>), <span class="dt">nest =</span> <span class="ot">FALSE</span>),
  <span class="dt">students =</span> <span class="kw"><a href="../reference/cross_level.html">cross_level</a></span>(<span class="dt">N =</span> <span class="dv">1500</span>, <span class="dt">by =</span> <span class="kw"><a href="../reference/join.html">join</a></span>(ps_quality, ss_quality, <span class="dt">rho =</span> <span class="fl">0.5</span>),
                         <span class="dt">SAT_score =</span> <span class="dv">800</span> <span class="op">+</span><span class="st"> </span>
<span class="st">                           </span><span class="dv">13</span> <span class="op">*</span><span class="st"> </span>ps_quality <span class="op">+</span><span class="st"> </span>
<span class="st">                           </span><span class="dv">26</span> <span class="op">*</span><span class="st"> </span>ss_quality <span class="op">+</span><span class="st"> </span>
<span class="st">                           </span><span class="kw">rnorm</span>(N, <span class="dv">0</span>, <span class="dv">50</span>))
)</code></pre></div>
<p>Here, we have changed the structure of our [<code><a href="../reference/join.html">join()</a></code>] function call. First, the variables we are joining on are <code>ps_quality</code> and <code>ss_quality</code>. Second, we specify a Spearman’s (rank) correlation coefficient, <code>rho</code>, which will induce a correlation in the resulting data based on the join function. In this case, we want a correlation between <code>ps_quality</code> and <code>ss_quality</code> of 0.5.</p>
<p>Technical details of the implementation of this function are contained below, but in the mean time the important thing to note is that <code>rho</code> can be any value from -1 to 1, and that the resulting correlation will be approximately equal to <code>rho</code>. <em>Note: Because of the technical details of our implementation, the true correlation in the resulting data will be slightly attenuated from the specified <code>rho</code>. There is no general purpose correction to compensate for this attenuation.</em></p>
<p>We can check the resulting correlation here:</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="kw">cor</span>(corr_data<span class="op">$</span>ps_quality, corr_data<span class="op">$</span>ss_quality)</code></pre></div>
<p>0.47</p>
<p>It should be noted that the specified correlation exists only within the variables on which a join was specified: other variables from either data source will not be explicitly connected except through the joined variables.</p>
</div>
<div id="joining-more-than-two-levels" class="section level1">
<h1 class="hasAnchor">
<a href="#joining-more-than-two-levels" class="anchor"></a>Joining more than two levels</h1>
<p>All of the functions specified above work when joining more than two levels. We could extend our student example to include, for example, college quality. Nothing changes about the join syntax beyond the addition of the third or subsequent variable names:</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">three_data &lt;-<span class="st"> </span><span class="kw"><a href="../reference/fabricate.html">fabricate</a></span>(
  <span class="dt">primary_schools =</span> <span class="kw"><a href="../reference/fabricate.html">add_level</a></span>(<span class="dt">N =</span> <span class="dv">20</span>, <span class="dt">ps_quality =</span> <span class="kw">runif</span>(N, <span class="dv">1</span>, <span class="dv">10</span>)),
  <span class="dt">secondary_schools =</span> <span class="kw"><a href="../reference/fabricate.html">add_level</a></span>(<span class="dt">N =</span> <span class="dv">15</span>, <span class="dt">ss_quality =</span> <span class="kw">runif</span>(N, <span class="dv">1</span>, <span class="dv">10</span>), <span class="dt">nest =</span> <span class="ot">FALSE</span>),
  <span class="dt">colleges =</span> <span class="kw"><a href="../reference/fabricate.html">add_level</a></span>(<span class="dt">N =</span> <span class="dv">50</span>, <span class="dt">c_quality =</span> <span class="kw">runif</span>(N, <span class="dv">1</span>, <span class="dv">10</span>), <span class="dt">nest =</span> <span class="ot">FALSE</span>),
  <span class="dt">students =</span> <span class="kw"><a href="../reference/cross_level.html">cross_level</a></span>(<span class="dt">N =</span> <span class="dv">1500</span>, <span class="dt">by =</span> <span class="kw"><a href="../reference/join.html">join</a></span>(ps_quality, 
                                             ss_quality, 
                                             c_quality,
                                             <span class="dt">rho =</span> <span class="fl">0.2</span>),
                         <span class="dt">earning_potential =</span> <span class="dv">20000</span> <span class="op">+</span><span class="st"> </span>
<span class="st">                           </span><span class="dv">2000</span> <span class="op">*</span><span class="st"> </span>ps_quality <span class="op">+</span><span class="st"> </span>
<span class="st">                           </span><span class="dv">6000</span> <span class="op">*</span><span class="st"> </span>ss_quality <span class="op">+</span><span class="st"> </span>
<span class="st">                           </span><span class="dv">10000</span> <span class="op">*</span><span class="st"> </span>c_quality <span class="op">+</span><span class="st"> </span>
<span class="st">                           </span><span class="kw">rnorm</span>(N, <span class="dv">0</span>, <span class="dv">5000</span>))
)</code></pre></div>
<p>One potential source for failure is specifying an invalid <code>rho</code>. If you specify a <code>rho</code> that makes the correlation between the three variables impossible to obtain, the [<code><a href="../reference/fabricate.html">fabricate()</a></code>] call will fail. A common case of this occurring is specifying a negative <code>rho</code> with three or more levels – it is clear that if A is negative correlated with B, and B is negatively correlated with C, then A and C cannot be negatively correlated.</p>
<p>Instead of specifying a <code>rho</code> correlation coefficient, users can specify a <code>sigma</code> correlation matrix to make the resulting correlations more sophisticated. Consider the following setup:</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">sigma =<span class="st"> </span><span class="kw">matrix</span>(<span class="kw">c</span>(<span class="dv">1</span>, <span class="fl">0.4</span>, <span class="fl">0.2</span>,
                 <span class="fl">0.4</span>, <span class="dv">1</span>, <span class="fl">0.8</span>,
                 <span class="fl">0.2</span>, <span class="fl">0.8</span>, <span class="dv">1</span>),
               <span class="dt">ncol =</span> <span class="dv">3</span>, <span class="dt">nrow =</span> <span class="dv">3</span>)

adv_data &lt;-<span class="st"> </span><span class="kw"><a href="../reference/fabricate.html">fabricate</a></span>(
  <span class="dt">primary_schools =</span> <span class="kw"><a href="../reference/fabricate.html">add_level</a></span>(<span class="dt">N =</span> <span class="dv">20</span>, <span class="dt">ps_quality =</span> <span class="kw">runif</span>(N, <span class="dv">1</span>, <span class="dv">10</span>)),
  <span class="dt">secondary_schools =</span> <span class="kw"><a href="../reference/fabricate.html">add_level</a></span>(<span class="dt">N =</span> <span class="dv">15</span>, <span class="dt">ss_quality =</span> <span class="kw">runif</span>(N, <span class="dv">1</span>, <span class="dv">10</span>), <span class="dt">nest =</span> <span class="ot">FALSE</span>),
  <span class="dt">colleges =</span> <span class="kw"><a href="../reference/fabricate.html">add_level</a></span>(<span class="dt">N =</span> <span class="dv">50</span>, <span class="dt">c_quality =</span> <span class="kw">runif</span>(N, <span class="dv">1</span>, <span class="dv">10</span>), <span class="dt">nest =</span> <span class="ot">FALSE</span>),
  <span class="dt">students =</span> <span class="kw"><a href="../reference/cross_level.html">cross_level</a></span>(<span class="dt">N =</span> <span class="dv">1500</span>, <span class="dt">by =</span> <span class="kw"><a href="../reference/join.html">join</a></span>(ps_quality, 
                                             ss_quality, 
                                             c_quality,
                                             <span class="dt">sigma =</span> sigma),
                         <span class="dt">earning_potential =</span> <span class="dv">20000</span> <span class="op">+</span><span class="st"> </span>
<span class="st">                           </span><span class="dv">2000</span> <span class="op">*</span><span class="st"> </span>ps_quality <span class="op">+</span><span class="st"> </span>
<span class="st">                           </span><span class="dv">6000</span> <span class="op">*</span><span class="st"> </span>ss_quality <span class="op">+</span><span class="st"> </span>
<span class="st">                           </span><span class="dv">10000</span> <span class="op">*</span><span class="st"> </span>c_quality <span class="op">+</span><span class="st"> </span>
<span class="st">                           </span><span class="kw">rnorm</span>(N, <span class="dv">0</span>, <span class="dv">5000</span>))
)</code></pre></div>
<p><code>sigma</code> must be specified as a symmetric square matrix with a diagonal of all 1s and a feasible correlation structure.</p>
</div>
<div id="technical-appendix-implementation-of-correlated-joins-" class="section level1">
<h1 class="hasAnchor">
<a href="#technical-appendix-implementation-of-correlated-joins-" class="anchor"></a>Technical appendix: Implementation of correlated joins.</h1>
<p>The implementation of the correlated join is done via the Gaussian copula. Mathematically, what is occurring is as follows:</p>
<ol style="list-style-type: decimal">
<li>User specifies a correlation structure.</li>
<li>Draw multivariate standard normal data with that correlation structure.</li>
<li>Transform the standard normal data for each dimension to quantiles of the standard normal cumulative distribution function.</li>
<li>Take the data from the source distribution at the empirical quantile equal to the quantiles from step 3. This ensures that the data being joined on have a Spearman’s (rank) correlation coefficient as specified in the multivariate standard normal draw.</li>
<li>Map the data chosen back to a row from the source distribution and join that row to the chosen row from the other source distributions, ensuring that all covariates are put in the resulting merged data.</li>
</ol>
</div>
</div>
  </div>

  <div class="col-md-3 hidden-xs hidden-sm" id="sidebar">
        <div id="tocnav">
      <h2 class="hasAnchor">
<a href="#tocnav" class="anchor"></a>Contents</h2>
      <ul class="nav nav-pills nav-stacked">
<li><a href="#generating-multiple-non-nested-levels-using-fabricatr">Generating multiple non-nested levels using <strong>fabricatr</strong></a></li>
      <li><a href="#importing-non-nested-data-frames">Importing non-nested data frames</a></li>
      <li><a href="#specifying-a-merge-function">Specifying a merge function</a></li>
      <li><a href="#adding-additional-variables">Adding additional variables</a></li>
      <li><a href="#correlations-after-merging">Correlations after merging</a></li>
      <li><a href="#joining-more-than-two-levels">Joining more than two levels</a></li>
      <li><a href="#technical-appendix-implementation-of-correlated-joins-">Technical appendix: Implementation of correlated joins.</a></li>
      </ul>
</div>
      </div>

</div>


      <footer><div class="copyright" style="flex:2;">
  <p>Developed by Graeme Blair, Jasper Cooper, Alexander Coppock, Macartan Humphreys, Aaron Rudkin.</p>
  <p>Code is licensed under <a href="https://opensource.org/licenses/mit-license.php">MIT</a> license.</p>
</div>

<div class="pkgdown">
  <p>Site built with <a href="http://hadley.github.io/pkgdown/">pkgdown</a>.</p>
</div>

      </footer>
</div>

  </body>
</html>
